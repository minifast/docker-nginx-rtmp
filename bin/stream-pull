#!/bin/bash

set -ex

INPUT_FLAGS="-strict experimental -fflags nobuffer -flags low_delay -rtsp_transport tcp -r 30"
OUTPUT_FLAGS="-c copy  -shortest -probesize 32 -f flv"

function on_die() {
  pkill -KILL -P $$
}

function urldecode() {
  local without_plus=${*//+/ }
  printf '%b' ${without_plus//%/\\x}
}

function run_ffmpeg() {
  RTMP_NAME=$(urldecode $1)
  echo ${INPUT_FLAGS} -i "rtsp://${RTMP_NAME}/cam/realmonitor?channel=1&subtype=0" ${OUTPUT_FLAGS} -f flv rtmp://localhost/stream/${RTMP_NAME}
}

if [ $(basename "${0}") = "stream-pull" ]
then
  trap 'on_die' TERM
  ffmpeg $(run_ffmpeg $1) &
  wait
fi
