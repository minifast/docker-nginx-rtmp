#!/bin/bash

set -ex

function on_die() {
  pkill -KILL -P $$
}

function urldecode() {
  local without_plus=${*//+/ }
  printf '%b' ${without_plus//%/\\x}
}

function overencode() {
  printf '%b' "${*//%/%25}"
}

function rtsp_to_rtmp() {
  RTMP_NAME=$1
  FRAME_RATE=$2
  SKIP_OVERENCODE=$3
  DECODED_RTMP_NAME=$(urldecode $RTMP_NAME)

  if [ -z "${SKIP_OVERENCODE}" ]
  then
    OVERENCODED_RTMP_NAME=$(overencode $RTMP_NAME)
  else
    OVERENCODED_RTMP_NAME=$RTMP_NAME
  fi

  INPUT_FLAGS="-fflags nobuffer -flags low_delay -strict experimental -rtsp_transport tcp -r ${FRAME_RATE}"
  OUTPUT_FLAGS="-c:v copy -c:a aac -ar 44100"

  if [[ $DECODED_RTMP_NAME == *"^"* ]]
  then
    echo ${INPUT_FLAGS} -i "${DECODED_RTMP_NAME%^*}" -stream_loop -1 -i "${DECODED_RTMP_NAME#*^}" -map 0:v -map 1:a ${OUTPUT_FLAGS} -shortest -f flv "rtmp://localhost/rtsp-${FRAME_RATE}/${OVERENCODED_RTMP_NAME}"
  else
    echo ${INPUT_FLAGS} -i "${DECODED_RTMP_NAME}" ${OUTPUT_FLAGS} -f flv "rtmp://localhost/rtsp-${FRAME_RATE}/${OVERENCODED_RTMP_NAME}"
  fi
}

if [ $(basename "${0}") = "rtsp-pull" ]
then
  trap 'on_die' TERM
  ffmpeg $(rtsp_to_rtmp $1 $2 $3) &
  wait
fi
